---
import BaseLayout from '../layouts/BaseLayout.astro';
import { supabase } from '../lib/supabase';

let message = 'جاري التحقق من الرابط...';
let isSuccess = false;
let debugInfo = ''; // لعرض تفاصيل الـ debug في الصفحة

try {
  // قراءة الـ params
  const token = Astro.url.searchParams.get('token');
  const id = Astro.url.searchParams.get('id');

  // تسجيل للـ terminal
  console.log('[CANCEL DEBUG] URL params raw:', Astro.url.search.toString());
  console.log('[CANCEL DEBUG] token:', token);
  console.log('[CANCEL DEBUG] id:', id);

  if (!token || !id) {
    throw new Error('الرابط ناقص (token أو id مفقود)');
  }

  // استعلام بسيط ومفصل
  const { data, error, count } = await supabase
    .from('appointments')
    .select('id, cancel_token', { count: 'exact' })
    .eq('id', id)
    .eq('cancel_token', token);

  // تسجيل النتيجة
  console.log('[CANCEL DEBUG] Supabase query result:', {
    count,
    data: data ? data[0] : null,
    error: error ? error.message : null
  });

  // عرض الـ debug في الصفحة
  debugInfo = JSON.stringify({
    received_token: token,
    received_id: id,
    query_count: count,
    query_error: error?.message || 'لا يوجد خطأ'
  }, null, 2);

  if (error) {
    throw new Error(`خطأ في الاستعلام من Supabase: ${error.message}`);
  }

  if (count !== 1 || !data || data.length !== 1) {
    throw new Error(`لم يتم العثور على حجز مطابق (عدد السجلات: ${count})`);
  }

  // الإلغاء
  const { error: updateError } = await supabase
    .from('appointments')
    .update({ status: 'cancelled' })
    .eq('id', id);

  if (updateError) {
    console.error('[CANCEL DEBUG] Update error:', updateError);
    throw new Error(`فشل تحديث حالة الحجز: ${updateError.message}`);
  }

  isSuccess = true;
  message = 'تم إلغاء الموعد بنجاح';

} catch (err) {
  console.error('[CANCEL DEBUG] Full error:', err);
  message = err.message || 'حدث خطأ غير متوقع';
}
---

<BaseLayout title={isSuccess ? 'تم إلغاء الموعد' : 'خطأ في الإلغاء'}>
  <div class="max-w-2xl mx-auto text-center py-16 px-6">
    <h1 class={`text-4xl font-bold mb-8 ${isSuccess ? 'text-green-600' : 'text-red-600'}`}>
      {message}
    </h1>

    {isSuccess ? (
      <div class="bg-green-50 border border-green-200 rounded-xl p-8 mb-8">
        <p class="text-xl mb-4">
          تم إلغاء حجزك بنجاح.
        </p>
        <p class="text-gray-700">
          لن يتم خصم أي رسوم، ويمكنك حجز موعد جديد في أي وقت.
        </p>
      </div>
    ) : (
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 mb-8">
        <p class="text-xl mb-4">
          الرابط غير صالح أو منتهي الصلاحية.
        </p>
        <p class="text-gray-700 mb-4">
          يرجى التحقق من الرابط أو التواصل معنا مباشرة.
        </p>
        <details class="text-left text-sm text-gray-600">
          <summary class="cursor-pointer font-medium">تفاصيل الخطأ (للـ debugging)</summary>
          <pre class="bg-gray-100 p-4 rounded mt-2 overflow-auto text-xs">{debugInfo}</pre>
        </details>
      </div>
    )}

    <a
      href="/"
      class="inline-block px-10 py-4 bg-blue-600 text-white font-medium rounded-xl hover:bg-blue-700 transition shadow-md"
    >
      العودة إلى الصفحة الرئيسية
    </a>
  </div>
</BaseLayout>