---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { useTranslations } from '../../i18n/utils.ts';

const t = useTranslations(Astro.currentLocale ?? 'ar');

const pageTitle           = t('booking.title');
const fullNameLabel       = t('booking.full_name');
const fullNamePlaceholder = t('booking.full_name_placeholder');
const emailLabel          = t('booking.email');
const emailPlaceholder    = t('booking.email_placeholder');
const phoneLabel          = t('booking.phone');
const phonePlaceholder    = t('booking.phone_placeholder');
const reasonLabel         = t('booking.reason');
const reasonPlaceholder   = t('booking.reason_placeholder');
const dateLabel           = t('booking.date');
const timeLabel           = t('booking.time');
const requiredText        = t('booking.required');
const submitButton        = t('buttons.submit');
const successMsg          = t('booking.success_message');
const errorMsg            = t('booking.error_message');

const chooseDateText      = t('booking.choose_date');
const chooseTimeText      = t('booking.choose_time');
const selectDateFirst     = t('booking.select_date_first');
const noTimesAvailable    = t('booking.no_times_available');
const dateTriggerDefault  = t('booking.date_trigger_default');
const timeTriggerDefault  = t('booking.time_trigger_default');
---

<BaseLayout title={pageTitle}>
  <section class="booking-form">
    <div class="booking-form__container">
      <h1 class="booking-form__title">{pageTitle}</h1>

      <form id="bookingForm" class="booking-form__form">
        <div class="booking-form__group">
          <label for="full_name">{fullNameLabel} <span class="required">*</span></label>
          <input type="text" id="full_name" name="full_name" required placeholder={fullNamePlaceholder} maxlength="40" minlength="3"/>
        </div>

        <div class="booking-form__group">
          <label for="email">{emailLabel} <span class="required">*</span></label>
          <input type="email" id="email" name="email" required placeholder={emailPlaceholder} autocomplete="email" maxlength="70"/>
   <div class="under_input"> A confirmation email will be sent to your inbox</div>    
        </div>

        <div class="booking-form__group">
          <label for="phone">{phoneLabel} <span class="required">*</span></label>
          <input type="tel" id="phone" name="phone" required placeholder={phonePlaceholder} autocomplete="tel" inputmode="numeric" pattern="[0-9+]*" maxlength="20" title="Numbers only" />
        </div>

        <div class="booking-form__row date-time-row">
          <div class="booking-form__group half">
            <label for="appointment_date_display">{dateLabel} <span class="required">*</span></label>
            <div class="custom-picker-trigger" id="date-trigger" tabindex="0" role="button">
              {dateTriggerDefault}
            </div>
            <input type="hidden" id="appointment_date" name="appointment_date" required />
            
            <!-- Dropdown للتواريخ -->
            <div class="dropdown-menu hidden" id="date-dropdown">
              <div class="scroll-container" id="date-scroll"></div>
            </div>
          </div>

          <div class="booking-form__group half">
            <label for="appointment_time_display">{timeLabel} <span class="required">*</span></label>
            <div class="custom-picker-trigger" id="time-trigger" tabindex="0" role="button">
              {timeTriggerDefault}
            </div>
            <input type="hidden" id="appointment_time" name="appointment_time" required />
            
            <!-- Dropdown للأوقات -->
            <div class="dropdown-menu hidden" id="time-dropdown">
              <div class="scroll-container" id="time-scroll"></div>
            </div>
          </div>
        </div>

        <div class="booking-form__group">
          <label for="reason">{reasonLabel}</label>
          <textarea id="reason" name="reason" rows="5" maxlength="500" placeholder={reasonPlaceholder}></textarea>
        </div>

        <div id="message" class="booking-form__message booking-form__message--hidden"
                 data-success-msg={successMsg} data-error-msg={errorMsg}></div>
        
        <button type="submit" class="booking-form__submit">{submitButton}</button>
    </form>
   </div>
  </section>

  <script>
    const EDGE_FUNCTION_URL = `${import.meta.env.PUBLIC_SUPABASE_URL}/functions/v1/check-booked-times`;

    const form = document.getElementById('bookingForm');
    const messageDiv = document.getElementById('message');
    const successMsg = messageDiv.dataset.successMsg;
    const errorMsgBase = messageDiv.dataset.errorMsg;

    const locale = document.documentElement.lang || 'ar';
    const isArabic = locale.startsWith('ar');

    const dateTriggerDefault = isArabic ? 'اختر التاريخ ←' : 'Choose date ←';
    const timeTriggerDefault = isArabic ? 'اختر الوقت ←' : 'Choose time ←';
    const selectDateFirstMsg = isArabic ? 'اختر التاريخ أولاً' : 'Select date first';
    const noTimesAvailableMsg = isArabic ? 'لا توجد مواعيد متاحة' : 'No times available';

    // ──────────────────────────────────────────────
    //                 إرسال النموذج
    // ──────────────────────────────────────────────
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      messageDiv.classList.remove('booking-form__message--hidden', 'success', 'error');
      messageDiv.textContent = isArabic ? 'جاري الإرسال...' : 'Submitting...';

      const formData = new FormData(form);

      try {
        const lang = document.documentElement.lang || 'ar';
        const response = await fetch(`/api/submit-booking?lang=${lang}`, { method: 'POST', body: formData });
        const result = await response.json();

        if (response.ok) {
          messageDiv.classList.add('success');
          messageDiv.textContent = result.message || successMsg;
          form.reset();

          document.getElementById('date-trigger').textContent = dateTriggerDefault;
          document.getElementById('time-trigger').textContent = timeTriggerDefault;
          document.getElementById('appointment_date').value = '';
          document.getElementById('appointment_time').value = '';

          document.getElementById('date-dropdown')?.classList.add('hidden');
          document.getElementById('time-dropdown')?.classList.add('hidden');
        } else {
          throw new Error(result.error || errorMsgBase);
        }
      } catch (err) {
        messageDiv.classList.add('error');
        messageDiv.textContent = err.message || errorMsgBase;
      }
    });

    // ──────────────────────────────────────────────
    //     جلب المواعيد المحجوزة
    // ──────────────────────────────────────────────
    async function getBookedTimesForDate(dateStr) {
      try {
        const response = await fetch(EDGE_FUNCTION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
          },
          body: JSON.stringify({ date: dateStr }),
        });

        if (!response.ok) return new Set();
        const json = await response.json();
        if (json.error) return new Set();
        const booked = json.booked || [];
        return new Set(Array.isArray(booked) ? booked : []);
      } catch {
        return new Set();
      }
    }

    // ──────────────────────────────────────────────
    //               التواريخ dropdown
    // ──────────────────────────────────────────────
    const today = new Date();
    const dateTrigger = document.getElementById('date-trigger');
    const dateDropdown = document.getElementById('date-dropdown');
    const dateScroll = document.getElementById('date-scroll');
    const dateHidden = document.getElementById('appointment_date');

    async function generateDates() {
      dateScroll.innerHTML = '';
      let added = 0;
      let offset = 0;

      while (added < 15) {
        const d = new Date();
        d.setDate(today.getDate() + offset);
        offset++;

        if (d.getDay() === 5) continue;

        const dateStr = d.toISOString().split('T')[0];
        const dayName = d.toLocaleDateString(locale, { weekday: 'long' });
        const dayNum = d.getDate().toString().padStart(2, '0');
        const monthName = d.toLocaleDateString(locale, { month: 'long' });
        const year = d.getFullYear();

        const display = isArabic
          ? `${dayName} ${dayNum} ${monthName} ${year}`
          : `${dayName}, ${monthName} ${dayNum}, ${year}`;

        const item = document.createElement('div');
        item.className = 'scroll-item';
        item.dataset.value = dateStr;
        item.textContent = display;
        dateScroll.appendChild(item);
        added++;
      }
    }

    dateScroll.addEventListener('click', (e) => {
      const item = e.target.closest('.scroll-item');
      if (!item) return;
      dateScroll.querySelectorAll('.scroll-item').forEach(el => el.classList.remove('selected'));
      item.classList.add('selected');
    });

    dateTrigger.addEventListener('click', async (e) => {
      e.stopPropagation();
      const isOpen = !dateDropdown.classList.contains('hidden');

      // إغلاق الآخر إذا مفتوح
      document.getElementById('time-dropdown')?.classList.add('hidden');

      if (isOpen) {
        dateDropdown.classList.add('hidden');
      } else {
        await generateDates();
        dateDropdown.classList.remove('hidden');

        if (dateHidden.value) {
          const sel = dateScroll.querySelector(`[data-value="${dateHidden.value}"]`);
          if (sel) {
            sel.classList.add('selected');
            sel.scrollIntoView({ block: 'center', behavior: 'instant' });
          }
        }
      }
    });

    // إغلاق الـ dropdown عند النقر خارجها
    document.addEventListener('click', (e) => {
      if (!dateTrigger.contains(e.target) && !dateDropdown.contains(e.target)) {
        dateDropdown.classList.add('hidden');
      }
      if (!timeTrigger.contains(e.target) && !timeDropdown.contains(e.target)) {
        timeDropdown.classList.add('hidden');
      }
    });

    // ──────────────────────────────────────────────
    //               الأوقات dropdown
    // ──────────────────────────────────────────────
    const timeTrigger = document.getElementById('time-trigger');
    const timeDropdown = document.getElementById('time-dropdown');
    const timeScroll = document.getElementById('time-scroll');
    const timeHidden = document.getElementById('appointment_time');

    async function generateTimes() {
      timeScroll.innerHTML = '';

      const selectedDate = dateHidden.value;
      if (!selectedDate) {
        timeScroll.innerHTML = `<div class="scroll-item disabled">${selectDateFirstMsg}</div>`;
        return;
      }

      const booked = await getBookedTimesForDate(selectedDate);
      let hasAvailable = false;

      for (let h = 12; h <= 22; h++) {
        for (let m = 0; m < 60; m += 15) {
          const time24 = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
          if (booked.has(time24)) continue;

          hasAvailable = true;

          let display = isArabic
            ? (h === 12 ? `12:${m.toString().padStart(2,'0')} ظهرًا`
               : h > 12 ? `${(h-12).toString().padStart(2,'0')}:${m.toString().padStart(2,'0')} مساءً`
               : `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')} صباحًا`)
            : `${(h % 12 || 12)}:${m.toString().padStart(2,'0')} ${h < 12 ? 'AM' : 'PM'}`;

          const item = document.createElement('div');
          item.className = 'scroll-item';
          item.dataset.value = time24;
          item.textContent = display;
          timeScroll.appendChild(item);
        }
      }

      if (!hasAvailable) {
        timeScroll.innerHTML = `<div class="scroll-item disabled">${noTimesAvailableMsg}</div>`;
      }
    }

    timeScroll.addEventListener('click', (e) => {
      const item = e.target.closest('.scroll-item');
      if (!item) return;
      timeScroll.querySelectorAll('.scroll-item').forEach(el => el.classList.remove('selected'));
      item.classList.add('selected');
    });

    timeTrigger.addEventListener('click', async (e) => {
      e.stopPropagation();
      const isOpen = !timeDropdown.classList.contains('hidden');

      document.getElementById('date-dropdown')?.classList.add('hidden');

      if (isOpen) {
        timeDropdown.classList.add('hidden');
      } else {
        await generateTimes();
        timeDropdown.classList.remove('hidden');

        if (timeHidden.value) {
          const sel = timeScroll.querySelector(`[data-value="${timeHidden.value}"]`);
          if (sel) {
            sel.classList.add('selected');
            sel.scrollIntoView({ block: 'center', behavior: 'smooth' });
          }
        }
      }
    });

    // اختيار وإغلاق الـ dropdown عند الضغط على عنصر
    [dateScroll, timeScroll].forEach(scroll => {
      scroll.addEventListener('click', (e) => {
        const item = e.target.closest('.scroll-item');
        if (!item || item.classList.contains('disabled')) return;

        const trigger = scroll.id === 'date-scroll' ? dateTrigger : timeTrigger;
        const hidden = scroll.id === 'date-scroll' ? dateHidden : timeHidden;
        const dropdown = scroll.id === 'date-scroll' ? dateDropdown : timeDropdown;

        trigger.textContent = item.textContent;
        hidden.value = item.dataset.value;
        dropdown.classList.add('hidden');
      });
    });
  </script>

  <style>
    .booking-form {
      padding: 4rem 1rem;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .booking-form__container {
      background: white;
      padding: 2.5rem;
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      max-width: 480px;
      width: 100%;
    }

    .booking-form__title {
      font-size: 2.1rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 2rem;
      background: linear-gradient(to right, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .booking-form__form {
      display: flex;
      flex-direction: column;
      gap: 1.6rem;
    }

    .booking-form__group {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .required { color: #ef4444; font-size: 0.95rem; }

    .under_input{ color: blue; font-size: 0.8rem; }

    input, textarea {
      padding: 0.85rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 0.6rem;
      font-size: 1rem;
      background: #f9fafb;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
      background: white;
    }

    textarea { resize: vertical; min-height: 100px; }

    .date-time-row {
      display: flex;
      gap: 1.2rem;
      flex-wrap: wrap;
    }

    .half { flex: 1; min-width: 140px; }

    .booking-form__submit {
      margin-top: 1rem;
      padding: 1rem;
      background: linear-gradient(90deg, #3b82f6, #6366f1);
      color: white;
      border: none;
      border-radius: 0.6rem;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
    }

    .booking-form__submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59,130,246,0.25);
    }

    .booking-form__message {
      padding: 1rem;
      border-radius: 0.6rem;
      text-align: center;
      font-weight: 500;
      margin-top: 1rem;
    }

    .booking-form__message--hidden { display: none; }
    .success { background: #ecfdf5; color: #065f46; border: 1px solid #6ee7b7; }
    .error   { background: #fef2f2; color: #991b1b; border: 1px solid #fca5a5; }

    .custom-picker-trigger {
      padding: 0.85rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 0.6rem;
      background: #f9fafb;
      cursor: pointer;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 1rem;
      color: #374151;
      user-select: none;
    }

    .custom-picker-trigger::after {
      content: '▼';
      font-size: 0.9rem;
      color: #6b7280;
    }

    .custom-picker-trigger:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 0.5rem;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 0.6rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.12);
      z-index: 50;
      max-height: 280px;
      overflow: hidden;
    }

    .dropdown-menu.hidden { display: none; }

    .scroll-container {
      max-height: 260px;
      overflow-y: auto;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
    
.scroll-item {
  padding: 1rem 3rem 1rem 1rem;
  text-align: right;
  font-size: 1.05rem;
  cursor: pointer;
  transition: all 0.15s;
  color: #1f2937;
  position: relative;
  direction: rtl;
} 

.scroll-item:hover {
  background: #eff6ff;
  color: #2563eb;
}

.scroll-item.selected {
  background: #1d4ed8;
  color: white;
  font-weight: 600;
}

.scroll-item.disabled {
  color: #9ca3af;
  cursor: not-allowed;
  pointer-events: none;
  font-style: italic;
}

    @media (max-width: 640px) {
      .date-time-row { flex-direction: column; gap: 1.4rem; }
      .half { min-width: 100%; }
      .booking-form__container { padding: 2rem 1.4rem; }
    }
  </style>
</BaseLayout>