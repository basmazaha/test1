---
import BaseLayout from '../layouts/BaseLayout.astro'
import { supabase } from '../lib/supabase';

// متغيرات للتحكم في الحالة
let status = 'loading';
let message = 'جاري التحقق من الرابط...';
let errorMessage = '';

// قراءة الـ parameters من الـ URL
const token = Astro.url.searchParams.get('token');
const id = Astro.url.searchParams.get('id');

try {
  if (!token || !id) {
    throw new Error('الرابط ناقص أو غير مكتمل');
  }

  // التحقق من وجود الحجز والتوكن
  const { data: appointment, error } = await supabase
    .from('appointments')
    .select('id, cancel_token, status')
    .eq('id', id)
    .eq('cancel_token', token)
    .single();

  if (error) throw error;
  if (!appointment) throw new Error('الرابط غير صالح أو منتهي الصلاحية');

  // لو الحجز ملغي بالفعل
  if (appointment.status === 'cancelled') {
    status = 'already_cancelled';
    message = 'تم إلغاء هذا الموعد مسبقًا';
    return;
  }

  // تنفيذ الإلغاء
  const { error: updateError } = await supabase
    .from('appointments')
    .update({ status: 'cancelled' })
    .eq('id', id);

  if (updateError) throw updateError;

  status = 'success';
  message = 'تم إلغاء الموعد بنجاح';

} catch (err) {
  status = 'error';
  message = 'حدث خطأ أثناء معالجة الطلب';
  errorMessage = err.message || 'يرجى المحاولة مرة أخرى أو التواصل معنا مباشرة';
}
---

<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{status === 'success' ? 'تم إلغاء الموعد' : 'خطأ في الإلغاء'}</title>
  </head>

  <body class="cancel-page">
    <div class="cancel-page__container">
      <header class="cancel-page__header">
        <h1 class="cancel-page__title">
          {status === 'success' ? 'تم إلغاء الموعد' : status === 'already_cancelled' ? 'الموعد ملغي مسبقًا' : 'خطأ'}
        </h1>
      </header>

      <main class="cancel-page__main">
        <div class="cancel-page__status">
          {status === 'success' && <span class="cancel-page__icon success">✓</span>}
          {status === 'error' && <span class="cancel-page__icon error">✗</span>}
          {status === 'already_cancelled' && <span class="cancel-page__icon info">ℹ</span>}

          <p class="cancel-page__message">{message}</p>

          {errorMessage && (
            <p class="cancel-page__error-detail">{errorMessage}</p>
          )}
        </div>

        <a href="/" class="cancel-page__back-btn">
          العودة إلى الصفحة الرئيسية
        </a>
      </main>

      <footer class="cancel-page__footer">
        <p>عيادة د. عمرو © {new Date().getFullYear()}</p>
      </footer>
    </div>

    <style>
      :root {
        --primary: #2563eb;
        --success: #10b981;
        --error: #ef4444;
        --gray: #6b7280;
        --light: #f9fafb;
      }

      .cancel-page {
        min-height: 100vh;
        background: var(--light);
        font-family: system-ui, -apple-system, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem;
      }

      .cancel-page__container {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        max-width: 500px;
        width: 100%;
        overflow: hidden;
        text-align: center;
      }

      .cancel-page__header {
        background: var(--primary);
        color: white;
        padding: 2rem 1.5rem;
      }

      .cancel-page__title {
        margin: 0;
        font-size: 1.75rem;
      }

      .cancel-page__main {
        padding: 2rem 1.5rem;
      }

      .cancel-page__status {
        margin-bottom: 2rem;
      }

      .cancel-page__icon {
        font-size: 4.5rem;
        font-weight: bold;
        display: block;
        margin-bottom: 1rem;
      }

      .cancel-page__icon.success { color: var(--success); }
      .cancel-page__icon.error   { color: var(--error); }
      .cancel-page__icon.info    { color: var(--primary); }

      .cancel-page__message {
        font-size: 1.25rem;
        margin: 0 0 1rem;
        font-weight: 600;
      }

      .cancel-page__error-detail {
        color: var(--error);
        font-size: 1rem;
        margin: 1rem 0;
        padding: 1rem;
        background: #fee2e2;
        border-radius: 0.5rem;
      }

      .cancel-page__back-btn {
        display: inline-block;
        padding: 0.875rem 2rem;
        background: var(--primary);
        color: white;
        text-decoration: none;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 1.125rem;
        transition: background 0.2s;
      }

      .cancel-page__back-btn:hover {
        background: #1d4ed8;
      }

      .cancel-page__footer {
        background: #f3f4f6;
        padding: 1rem;
        font-size: 0.875rem;
        color: var(--gray);
      }

      @media (max-width: 480px) {
        .cancel-page__title { font-size: 1.5rem; }
        .cancel-page__icon  { font-size: 3.5rem; }
      }
    </style>
  </body>
</html>